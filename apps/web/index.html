<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µêµ¬ë°˜ì¥ - ìŠ¤ë§ˆíŠ¸ ê³µêµ¬ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0A0A0B',
                            800: '#1A1A1F',
                            700: '#2A2A2F',
                        },
                        accent: {
                            red: '#EF4444',
                            'red-dark': '#DC2626',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #0A0A0B;
            color: #FFFFFF;
        }

        .gradient-red {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%);
        }

        .card-dark {
            background: #1A1A1F;
            border: 1px solid #2A2A2F;
        }

        .stat-card {
            background: linear-gradient(135deg, #1A1A1F 0%, #2A2A2F 100%);
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- í—¤ë” -->
    <header class="border-b border-dark-700">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ› ï¸</span>
                <h1 class="text-xl font-bold">ê³µêµ¬ë°˜ì¥</h1>
            </div>
            <nav class="flex gap-2">
                <button onclick="showTab('dashboard')" id="btn-dashboard"
                    class="px-4 py-2 rounded-lg bg-dark-800 hover:bg-dark-700 transition">
                    ğŸ“Š í™ˆ
                </button>
                <button onclick="showTab('tools')" id="btn-tools"
                    class="px-4 py-2 rounded-lg bg-dark-800 hover:bg-dark-700 transition">
                    ğŸ“¦ ëª©ë¡
                </button>
                <button onclick="showTab('settings')" id="btn-settings"
                    class="px-4 py-2 rounded-lg bg-dark-800 hover:bg-dark-700 transition">
                    âš™ï¸ ì„¤ì •
                </button>
            </nav>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="tab-dashboard" class="tab-content">
            <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
            <section class="text-center py-16">
                <h2 class="text-5xl font-bold mb-4">
                    MAXIMIZE YOUR<br>
                    <span class="text-accent-red">TOOL MANAGEMENT</span>
                </h2>
                <p class="text-gray-400 text-lg mb-8">
                    ì´¬ì˜ë§Œìœ¼ë¡œ AIë¶„ì„ê³¼ ìë™ì¸ì‹<br>
                    ëŒ€ì—¬ë°˜ë‚© ê³µêµ¬í˜„í™©, ë§ì‹¤ê¸°ë¡ê´€ë¦¬, 100%ë¬´ë£Œ
                </p>
                <button onclick="showCamera()"
                    class="gradient-red px-8 py-4 rounded-xl text-lg font-bold hover:scale-105 transition shadow-lg">
                    âš¡ ê³µêµ¬ ë“±ë¡í•˜ê¸°
                </button>
            </section>

            <!-- í†µê³„ ì¹´ë“œ -->
            <section class="mb-12">
                <h3 class="text-2xl font-bold mb-6">ê³µêµ¬í˜„í™©</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card rounded-xl p-6 text-center">
                        <div class="text-sm text-gray-400 mb-2">ì´ ë³´ìœ </div>
                        <div class="text-4xl font-bold" id="stat-total">0</div>
                    </div>
                    <div class="stat-card rounded-xl p-6 text-center">
                        <div class="text-sm text-gray-400 mb-2">ëŒ€ì—¬ í˜„í™©</div>
                        <div class="text-4xl font-bold text-yellow-400" id="stat-rented">0</div>
                    </div>
                    <div class="stat-card rounded-xl p-6 text-center">
                        <div class="text-sm text-gray-400 mb-2">ëŒ€ì—¬ ê°€ëŠ¥</div>
                        <div class="text-4xl font-bold text-green-400" id="stat-available">0</div>
                    </div>
                    <div class="stat-card rounded-xl p-6 text-center">
                        <div class="text-sm text-gray-400 mb-2">ë§ì‹¤</div>
                        <div class="text-4xl font-bold text-red-400" id="stat-lost">0</div>
                    </div>
                </div>
            </section>

            <!-- ê¸°ëŠ¥ íƒ€ì¼ -->
            <section>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="showCamera()"
                        class="card-dark rounded-xl p-6 hover:scale-105 transition text-center">
                        <div class="text-4xl mb-3">ğŸ“·</div>
                        <div class="font-bold mb-1">ì´¬ì˜ ë“±ë¡</div>
                        <div class="text-sm text-gray-400">AIì´ë¯¸ì§€ë¶„ì„</div>
                    </button>
                    <button onclick="showTab('tools')"
                        class="card-dark rounded-xl p-6 hover:scale-105 transition text-center">
                        <div class="text-4xl mb-3">ğŸ“¦</div>
                        <div class="font-bold mb-1">ê³µêµ¬ ì‚¬ìš©</div>
                        <div class="text-sm text-gray-400">ì‚¬ìš© ê¸°ëŠ¥í•œ ê³µêµ¬ë§Œ</div>
                    </button>
                    <button class="card-dark rounded-xl p-6 hover:scale-105 transition text-center">
                        <div class="text-4xl mb-3">ğŸš¨</div>
                        <div class="font-bold mb-1">ë§ì‹¤ í˜„í™©</div>
                        <div class="text-sm text-gray-400">íŒŒì†ë¶„ì‹¤ê³ ì¥ í˜„í™©</div>
                    </button>
                    <button onclick="showTab('tools')"
                        class="card-dark rounded-xl p-6 hover:scale-105 transition text-center">
                        <div class="text-4xl mb-3">ğŸ“‚</div>
                        <div class="font-bold mb-1">ê³µêµ¬ ëª©ë¡</div>
                        <div class="text-sm text-gray-400">ì „ì²´ ìˆ˜ëŸ‰ ê°€ëŠ¥</div>
                    </button>
                </div>
            </section>
        </div>

        <!-- ê³µêµ¬ ëª©ë¡ íƒ­ -->
        <div id="tab-tools" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">ê³µêµ¬ ëª©ë¡</h2>
                <button onclick="showCamera()"
                    class="gradient-red px-6 py-3 rounded-lg font-bold hover:scale-105 transition">
                    + ìƒˆ ê³µêµ¬ ë“±ë¡
                </button>
            </div>

            <!-- ê²€ìƒ‰ ë°” -->
            <div class="mb-6">
                <input type="text" id="search-input" placeholder="ê³µêµ¬ ì´ë¦„, ë¸Œëœë“œ, ëª¨ë¸ë¡œ ê²€ìƒ‰..."
                    class="w-full bg-dark-800 border border-dark-700 rounded-lg px-4 py-3 focus:outline-none focus:border-accent-red"
                    onkeyup="searchTools()">
            </div>

            <!-- ê³µêµ¬ ë¦¬ìŠ¤íŠ¸ -->
            <div id="tools-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="card-dark rounded-xl p-6 text-center text-gray-400">
                    ë“±ë¡ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                    <button onclick="showCamera()" class="text-accent-red hover:underline mt-2">ì²« ê³µêµ¬ ë“±ë¡í•˜ê¸° â†’</button>
                </div>
            </div>
        </div>

        <!-- ì„¤ì • íƒ­ -->
        <div id="tab-settings" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">ì„¤ì •</h2>
            <div class="card-dark rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4">API ì„¤ì •</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ë°±ì—”ë“œ API URL</label>
                        <input type="text" id="api-url" value="http://localhost:3000/api/v1"
                            class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2">
                    </div>
                    <button onclick="saveSettings()" class="gradient-red px-6 py-3 rounded-lg font-bold">
                        ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ì¹´ë©”ë¼ ëª¨ë‹¬ -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
        <div class="bg-dark-800 rounded-2xl p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">ê³µêµ¬ ì´¬ì˜ ë“±ë¡</h3>
                <button onclick="closeCamera()" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <div class="space-y-6">
                <!-- ì¹´ë©”ë¼ ì˜ì—­ -->
                <div class="bg-dark-900 rounded-xl aspect-video relative overflow-hidden">
                    <video id="camera-stream" class="w-full h-full object-cover" autoplay playsinline></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <img id="captured-image" class="w-full h-full object-cover hidden" />

                    <!-- ì¹´ë©”ë¼ ìƒíƒœ ë©”ì‹œì§€ -->
                    <div id="camera-message" class="absolute inset-0 flex items-center justify-center text-center">
                        <div class="text-gray-400">
                            <div class="text-6xl mb-4">ğŸ“·</div>
                            <p>ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>

                <!-- ì´¬ì˜ ë²„íŠ¼ (ì¹´ë©”ë¼ í™œì„± ì‹œ) -->
                <div id="capture-controls" class="hidden">
                    <button onclick="capturePhoto()"
                        class="w-full gradient-red py-4 rounded-xl font-bold text-lg hover:scale-105 transition">
                        ğŸ“¸ ì´¬ì˜í•˜ê¸°
                    </button>
                </div>

                <!-- ì´¬ì˜ í›„ ì»¨íŠ¸ë¡¤ -->
                <div id="captured-controls" class="hidden space-y-3">
                    <div class="flex gap-3">
                        <button onclick="retakePhoto()"
                            class="flex-1 bg-dark-700 py-3 rounded-lg font-bold hover:bg-dark-600 transition">
                            ğŸ”„ ë‹¤ì‹œ ì´¬ì˜
                        </button>
                        <button onclick="approveAndAnalyze()"
                            class="flex-1 gradient-red py-3 rounded-lg font-bold hover:scale-105 transition">
                            âœ… AI ìŠ¹ì¸ (ë¶„ì„ ì‹œì‘)
                        </button>
                    </div>
                    <div id="upload-status" class="text-center text-sm text-gray-400"></div>
                </div>

                <!-- URL ì…ë ¥ + íŒŒì¼ ì—…ë¡œë“œ (í´ë°±/ëŒ€ì•ˆ) -->
                <div id="url-fallback" class="hidden space-y-4">
                    <div class="text-center text-sm text-gray-400 mb-3">
                        ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‚˜ìš”? ì•„ë˜ ë°©ë²•ìœ¼ë¡œë„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>

                    <!-- ë¡œì»¬ íŒŒì¼ ì—…ë¡œë“œ -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ğŸ“ ë¡œì»¬ íŒŒì¼ ì„ íƒ</label>
                        <input type="file" id="file-upload-input" accept="image/*" class="hidden"
                            onchange="handleFileUpload(this)">
                        <button onclick="document.getElementById('file-upload-input').click()"
                            class="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-3 text-left hover:bg-dark-600 transition flex items-center justify-between">
                            <span id="file-name-display" class="text-gray-400">íŒŒì¼ ì„ íƒ...</span>
                            <span class="text-accent-red">ğŸ“‚ ì°¾ì•„ë³´ê¸°</span>
                        </button>
                    </div>

                    <!-- êµ¬ë¶„ì„  -->
                    <div class="flex items-center gap-3">
                        <div class="flex-1 border-t border-dark-700"></div>
                        <span class="text-sm text-gray-500">ë˜ëŠ”</span>
                        <div class="flex-1 border-t border-dark-700"></div>
                    </div>

                    <!-- URL ì…ë ¥ -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ğŸ”— ì´ë¯¸ì§€ URL ì…ë ¥</label>
                        <input type="text" id="image-url-input" placeholder="https://example.com/tool-image.jpg"
                            class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-3">
                    </div>

                    <button onclick="analyzeFromUrlOrFile()"
                        class="w-full gradient-red py-4 rounded-xl font-bold text-lg hover:scale-105 transition">
                        AI ë¶„ì„ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI ë¶„ì„ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
        <div class="bg-dark-800 rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">AI ë¶„ì„ ê²°ê³¼</h3>
                <button onclick="closeResult()" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>

            <div id="analysis-results" class="space-y-4">
                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        // API Base URL - í˜„ì¬ ë„ë©”ì¸ ê¸°ì¤€
        const API_URL = window.location.origin.includes('localhost')
            ? 'http://localhost:4000/api/v1'
            : 'https://uconai.ddns.net/gonggu-api/api/v1';

        // AI ì„œë²„ URL (ì„ì‹œ: ì§ì ‘ í˜¸ì¶œ)
        const AI_URL = window.location.origin.includes('localhost')
            ? 'http://localhost:8000'
            : 'https://uconai.ddns.net:8000';

        let authToken = null;

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('gradient-red');
                btn.classList.add('bg-dark-800');
            });
            document.getElementById(`btn-${tabName}`).classList.remove('bg-dark-800');
            document.getElementById(`btn-${tabName}`).classList.add('gradient-red');

            // ê³µêµ¬ ëª©ë¡ íƒ­ì´ë©´ ë°ì´í„° ë¡œë“œ
            if (tabName === 'tools') {
                loadTools();
            } else if (tabName === 'dashboard') {
                loadStats();
            }
        }

        // ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        let capturedImageData = null;
        let uploadedImageUrl = null;

        // ì¹´ë©”ë¼ ëª¨ë‹¬
        async function showCamera() {
            document.getElementById('camera-modal').classList.remove('hidden');
            document.getElementById('camera-modal').classList.add('flex');

            // ì¹´ë©”ë¼ ì‹œì‘
            await startCamera();
        }

        function closeCamera() {
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            document.getElementById('camera-modal').classList.add('hidden');
            document.getElementById('camera-modal').classList.remove('flex');

            // ë¦¬ì…‹
            resetCameraModal();
        }

        function resetCameraModal() {
            document.getElementById('camera-stream').classList.remove('hidden');
            document.getElementById('captured-image').classList.add('hidden');
            document.getElementById('capture-controls').classList.add('hidden');
            document.getElementById('captured-controls').classList.add('hidden');
            document.getElementById('url-fallback').classList.add('hidden');
            document.getElementById('camera-message').classList.remove('hidden');
            capturedImageData = null;
            uploadedImageUrl = null;
        }

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',  // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                cameraStream = stream;
                const video = document.getElementById('camera-stream');
                video.srcObject = stream;

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('camera-message').classList.add('hidden');
                document.getElementById('capture-controls').classList.remove('hidden');

            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);

                // í´ë°±: URL ì…ë ¥
                document.getElementById('camera-message').innerHTML = `
                    <div class="text-gray-400">
                        <div class="text-6xl mb-4">âš ï¸</div>
                        <p>ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨</p>
                        <p class="text-sm mt-2">${error.message}</p>
                        <p class="text-sm mt-2">ì•„ë˜ì—ì„œ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                    </div>
                `;
                document.getElementById('url-fallback').classList.remove('hidden');
            }
        }

        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('camera-canvas');
            const capturedImage = document.getElementById('captured-image');

            // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¹„ë””ì˜¤ í¬ê¸°ì™€ ë§ì¶¤
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
            capturedImageData = canvas.toDataURL('image/jpeg', 0.9);

            // ìº¡ì²˜ëœ ì´ë¯¸ì§€ í‘œì‹œ
            capturedImage.src = capturedImageData;
            video.classList.add('hidden');
            capturedImage.classList.remove('hidden');

            // UI ì „í™˜
            document.getElementById('capture-controls').classList.add('hidden');
            document.getElementById('captured-controls').classList.remove('hidden');

            // ì¦‰ì‹œ ì„œë²„ì— ì—…ë¡œë“œ (DB ì €ì¥)
            uploadPhotoToDB();
        }

        // ë‹¤ì‹œ ì´¬ì˜
        function retakePhoto() {
            document.getElementById('camera-stream').classList.remove('hidden');
            document.getElementById('captured-image').classList.add('hidden');
            document.getElementById('capture-controls').classList.remove('hidden');
            document.getElementById('captured-controls').classList.add('hidden');
            document.getElementById('upload-status').textContent = '';
            capturedImageData = null;
            uploadedImageUrl = null;
        }

        // ì´¬ì˜ ì¦‰ì‹œ DB ì €ì¥
        async function uploadPhotoToDB() {
            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = 'ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';

            try {
                // Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                const blob = dataURLtoBlob(capturedImageData);
                const formData = new FormData();
                formData.append('file', blob, 'captured-tool.jpg');

                // ì„œë²„ ì—…ë¡œë“œ API í˜¸ì¶œ
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    uploadedImageUrl = data.url || data.imageUrl;
                    statusEl.innerHTML = 'âœ… ì €ì¥ ì™„ë£Œ! <span class="text-green-400">AI ìŠ¹ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</span>';
                } else {
                    // ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì„ì‹œ URL ì‚¬ìš©
                    uploadedImageUrl = capturedImageData;
                    statusEl.textContent = 'âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨ (ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©)';
                }
            } catch (error) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                uploadedImageUrl = capturedImageData;
                statusEl.textContent = 'âš ï¸ ì—…ë¡œë“œ ì˜¤ë¥˜ (ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©)';
            }
        }

        // AI ìŠ¹ì¸ ë° ë¶„ì„ ì‹œì‘
        async function approveAndAnalyze() {
            if (!uploadedImageUrl) {
                alert('ì´ë¯¸ì§€ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }

            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = 'ğŸ¤– AI ë¶„ì„ ì¤‘...';

            try {
                const response = await fetch(`${API_URL}/analyze/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    },
                    body: JSON.stringify({ imageUrl: uploadedImageUrl })
                });

                const data = await response.json();

                if (data.success && data.candidates) {
                    showAnalysisResults(data.candidates);
                    closeCamera();
                } else {
                    alert('ë¶„ì„ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
        let selectedFileData = null;

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // íŒŒì¼ëª… í‘œì‹œ
            document.getElementById('file-name-display').textContent = file.name;

            // íŒŒì¼ì„ Base64ë¡œ ì½ê¸°
            const reader = new FileReader();
            reader.onload = function (e) {
                selectedFileData = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // URL ë˜ëŠ” íŒŒì¼ë¡œ ë¶„ì„
        async function analyzeFromUrlOrFile() {
            let imageUrl = null;

            // 1. ì„ íƒëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if (selectedFileData) {
                imageUrl = selectedFileData;
            }
            // 2. URL ì…ë ¥ì´ ìˆëŠ”ì§€ í™•ì¸
            else {
                imageUrl = document.getElementById('image-url-input').value;
            }

            if (!imageUrl) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                // Base64 ì´ë¯¸ì§€ì¸ ê²½ìš° ë¨¼ì € ì„œë²„ì— ì—…ë¡œë“œ
                if (imageUrl.startsWith('data:image')) {
                    const blob = dataURLtoBlob(imageUrl);
                    const formData = new FormData();
                    formData.append('file', blob, 'uploaded-tool.jpg');

                    const uploadResponse = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken || 'demo-token'}`
                        },
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        imageUrl = uploadData.url || uploadData.imageUrl;
                    }
                }

                // AI ë¶„ì„ ì‹œì‘
                const response = await fetch(`${API_URL}/analyze/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    },
                    body: JSON.stringify({ imageUrl })
                });

                const data = await response.json();

                if (data.success && data.candidates) {
                    showAnalysisResults(data.candidates);
                    closeCamera();
                } else {
                    alert('ë¶„ì„ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // URLë¡œ ë¶„ì„ (í´ë°± - í˜¸í™˜ì„± ìœ ì§€)
        async function analyzeFromUrl() {
            const imageUrl = document.getElementById('image-url-input').value;
            if (!imageUrl) {
                alert('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/analyze/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    },
                    body: JSON.stringify({ imageUrl })
                });

                const data = await response.json();

                if (data.success && data.candidates) {
                    showAnalysisResults(data.candidates);
                    closeCamera();
                } else {
                    alert('ë¶„ì„ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        function closeResult() {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('result-modal').classList.remove('flex');
        }

        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function showAnalysisResults(candidates) {
            const container = document.getElementById('analysis-results');
            container.innerHTML = candidates.map((tool, idx) => `
                <div class="card-dark rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-bold">${idx + 1}. ${tool.name}</h4>
                            <p class="text-sm text-gray-400">${tool.brand} ${tool.model}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-accent-red">${(tool.confidence * 100).toFixed(0)}%</div>
                            <div class="text-xs text-gray-400">ì‹ ë¢°ë„</div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mb-4">
                        ${tool.category} â€¢ ${tool.type}<br>
                        ${tool.description || ''}
                        ${tool.price ? `<br>ì˜ˆìƒ ê°€ê²©: ${tool.price.toLocaleString()}ì›` : ''}
                    </div>
                    <button onclick="registerTool(${idx})" class="w-full gradient-red py-3 rounded-lg font-bold hover:scale-105 transition">
                        ì´ ê³µêµ¬ë¡œ ë“±ë¡í•˜ê¸°
                    </button>
                </div>
            `).join('');

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.analysisData = candidates;

            document.getElementById('result-modal').classList.remove('hidden');
            document.getElementById('result-modal').classList.add('flex');
        }

        // ê³µêµ¬ ë“±ë¡
        async function registerTool(index) {
            const tool = window.analysisData[index];

            try {
                const response = await fetch(`${API_URL}/tools`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    },
                    body: JSON.stringify({
                        name: tool.name,
                        brand: tool.brand,
                        model: tool.model,
                        category: tool.category,
                        type: tool.type,
                        status: 'available',
                        condition: 'excellent'
                    })
                });

                if (response.ok) {
                    alert('âœ… ê³µêµ¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeResult();
                    loadStats();
                    showTab('tools');
                } else {
                    alert('ë“±ë¡ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ë“±ë¡ ì˜¤ë¥˜:', error);
                alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    }
                });
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.summary.totalTools;
                document.getElementById('stat-rented').textContent = data.summary.rented;
                document.getElementById('stat-available').textContent = data.summary.available;
                document.getElementById('stat-lost').textContent = data.summary.lost;
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê³µêµ¬ ëª©ë¡ ë¡œë“œ
        async function loadTools() {
            try {
                const response = await fetch(`${API_URL}/tools`, {
                    headers: {
                        'Authorization': `Bearer ${authToken || 'demo-token'}`
                    }
                });
                const data = await response.json();

                const container = document.getElementById('tools-list');
                if (data.tools && data.tools.length > 0) {
                    container.innerHTML = data.tools.map(tool => `
                        <div class="card-dark rounded-xl p-6 hover:scale-105 transition">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="text-lg font-bold">${tool.name}</h4>
                                    <p class="text-sm text-gray-400">${tool.brand || ''} ${tool.model || ''}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs ${tool.status === 'available' ? 'bg-green-500/20 text-green-400' :
                            tool.status === 'rented' ? 'bg-yellow-500/20 text-yellow-400' :
                                'bg-red-500/20 text-red-400'
                        }">
                                    ${tool.status === 'available' ? 'ì‚¬ìš©ê°€ëŠ¥' : tool.status === 'rented' ? 'ëŒ€ì—¬ì¤‘' : 'ë§ì‹¤'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-400">
                                ${tool.category || ''} â€¢ ${tool.type || ''}<br>
                                ìƒíƒœ: ${tool.condition || 'unknown'}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="card-dark rounded-xl p-6 text-center text-gray-400">
                            ë“±ë¡ëœ ê³µêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                            <button onclick="showCamera()" class="text-accent-red hover:underline mt-2">ì²« ê³µêµ¬ ë“±ë¡í•˜ê¸° â†’</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ê³µêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê²€ìƒ‰
        function searchTools() {
            const query = document.getElementById('search-input').value;
            // TODO: ê²€ìƒ‰ êµ¬í˜„
        }

        // ì„¤ì • ì €ì¥
        function saveSettings() {
            API_URL = document.getElementById('api-url').value;
            localStorage.setItem('apiUrl', API_URL);
            alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // ì €ì¥ëœ API URL ë¡œë“œ
            const savedUrl = localStorage.getItem('apiUrl');
            if (savedUrl) {
                API_URL = savedUrl;
                document.getElementById('api-url').value = savedUrl;
            }

            // ì„ì‹œ í† í° (ì‹¤ì œë¡œëŠ” ë¡œê·¸ì¸ í›„ ë°›ì•„ì•¼ í•¨)
            // ë°ëª¨ìš©ìœ¼ë¡œ ìë™ íšŒì›ê°€ì…/ë¡œê·¸ì¸
            autoLogin();
        });

        // ìë™ ë¡œê·¸ì¸ (ë°ëª¨ìš©)
        async function autoLogin() {
            try {
                // íšŒì›ê°€ì… ì‹œë„
                const registerRes = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@gonggubanjang.com',
                        password: 'demo1234',
                        name: 'ë°ëª¨ ì‚¬ìš©ì'
                    })
                });

                if (registerRes.ok) {
                    const data = await registerRes.json();
                    authToken = data.token;
                } else {
                    // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¡œê·¸ì¸
                    const loginRes = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'demo@gonggubanjang.com',
                            password: 'demo1234'
                        })
                    });

                    if (loginRes.ok) {
                        const data = await loginRes.json();
                        authToken = data.token;
                    }
                }

                // í†µê³„ ë¡œë“œ
                loadStats();
            } catch (error) {
                console.error('ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
            }
        }
    </script>
</body>

</html>